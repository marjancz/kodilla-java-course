-- ALTER TABLE BOOKS ADD BESTSELLER BOOLEAN;

DROP PROCEDURE IF EXISTS UpdateBestsellers;

DELIMITER $$

CREATE PROCEDURE UpdateBestsellers()
BEGIN
	DECLARE BOOKSREAD, DAYS, BK_ID int;
  DECLARE BOOKSPERMONTH DECIMAL(5,2);
  DECLARE FINISHED int DEFAULT 0;
  DECLARE ALL_BOOKS CURSOR FOR SELECT BOOK_ID FROM BOOKS;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET FINISHED = 1;
  OPEN ALL_BOOKS;
  WHILE (FINISHED = 0) DO
		FETCH ALL_BOOKS INTO BK_ID;
    IF (FINISHED = 0) THEN
			SELECT COUNT(*) FROM RENTS
        WHERE BOOK_ID = BK_ID
        INTO BOOKSREAD;
			SELECT DATEDIFF(MAX(RENT_DATE), MIN(RENT_DATE)) + 1 FROM RENTS
			  WHERE BOOK_ID = BK_ID
        INTO DAYS;
      SET BOOKSPERMONTH = BOOKSREAD / DAYS * 30;
				IF BOOKSPERMONTH > 2 THEN
				  UPDATE BOOKS SET BESTSELLER = TRUE
          WHERE BOOK_ID = BK_ID;
				ELSE
				  UPDATE BOOKS SET BESTSELLER = FALSE
          WHERE BOOK_ID = BK_ID;
			  END IF;
			COMMIT;
		END IF;
	END WHILE;
  CLOSE ALL_BOOKS;

END $$

DELIMITER ;